<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>พูดแล้วส่งอีเมลต่อเนื่อง</title>
</head>
<body>
    <h1>พูดข้อความเพื่อส่งอีเมล</h1>
    <p id="status">สถานะ: รอการพูด...</p>

    <script>
        const status = document.getElementById('status');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'th-TH';
        recognition.interimResults = false;
        recognition.continuous = false; // ฟังครั้งละประโยค แล้วรีสตาร์ท

        let listeningTimeout;

        async function startListening() {
            try {
                recognition.start();
            } catch (err) {
                console.error('Error starting recognition:', err);
            }
        }

        recognition.onstart = () => {
            status.textContent = 'สถานะ: กำลังฟัง...';
        };

        recognition.onresult = async (event) => {
            const text = event.results[0][0].transcript.trim();
            if (!text) return;

            status.textContent = 'คุณพูด: ' + text;

            // ส่งไป backend
            try {
                const response = await fetch('/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text }) 
                });
                const data = await response.json();
                if(data.success){
                    status.textContent += ' → ส่งอีเมลเรียบร้อย!';
                } else {
                    status.textContent += ' → ส่งล้มเหลว: ' + data.error;
                }
            } catch(err) {
                status.textContent += ' → เกิดข้อผิดพลาด: ' + err;
            }

            // หน่วงเวลา 3 วินาที ก่อนเริ่มฟังใหม่
            clearTimeout(listeningTimeout);
            listeningTimeout = setTimeout(startListening, 3000);
        };

        recognition.onerror = (event) => {
            status.textContent = 'เกิดข้อผิดพลาด: ' + event.error;
            // หน่วงเวลา 5 วินาที ก่อนลองฟังใหม่
            clearTimeout(listeningTimeout);
            listeningTimeout = setTimeout(startListening, 5000);
        };

        recognition.onend = () => {
            // รีสตาร์ท session ถ้าไม่ได้พูด หลังหน่วงเวลา 2 วินาที
            clearTimeout(listeningTimeout);
            listeningTimeout = setTimeout(startListening, 2000);
        };

        window.onload = () => {
            startListening();
        };
    </script>
</body>
</html>
