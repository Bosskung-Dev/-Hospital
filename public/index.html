<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>พูดแล้วส่งอีเมลต่อเนื่อง</title>
</head>
<body>
    <h1>พูดข้อความเพื่อส่งอีเมล</h1>
    <p id="status">สถานะ: รอการพูด...</p>

    <script>
        const status = document.getElementById('status');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'th-TH';
        recognition.interimResults = false;
        recognition.continuous = false; // ฟังครั้งละประโยค แล้วรีสตาร์ท

        async function startListening() {
            recognition.start();
        }

        recognition.onstart = () => {
            status.textContent = 'สถานะ: กำลังฟัง...';
        };

        recognition.onresult = async (event) => {
            const message = event.results[0][0].transcript;
            status.textContent = 'คุณพูด: ' + message;

            // ส่งไป backend
            try {
                const response = await fetch('/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                if(data.success){
                    status.textContent += ' → ส่งอีเมลเรียบร้อย!';
                } else {
                    status.textContent += ' → ส่งล้มเหลว: ' + data.error;
                }
            } catch(err) {
                status.textContent += ' → เกิดข้อผิดพลาด: ' + err;
            }

            // หน่วงเวลา 1 วินาทีแล้วเริ่มฟังใหม่
            setTimeout(() => {
                startListening();
            }, 5000);
        };

        recognition.onerror = (event) => {
            status.textContent = 'เกิดข้อผิดพลาด: ' + event.error;

            // ถ้า error ก็ลองเริ่มฟังใหม่หลังหน่วงเวลา
            setTimeout(() => {
                startListening();
            }, 5000);
        };

        recognition.onend = () => {
            // ถ้า session จบโดยไม่ได้พูด ให้เริ่มฟังใหม่หลังหน่วงเวลา
            setTimeout(() => {
                startListening();
            }, 3000);
        };

        // เริ่มฟังทันทีเมื่อโหลดหน้าเว็บ
        window.onload = () => {
            startListening();
        };
    </script>
</body>
</html>
